{
    "version": "https://jsonfeed.org/version/1",
    "title": "Queek blog • All posts by \"xlsx\" category",
    "description": "like dream",
    "home_page_url": "https://queek.cn",
    "items": [
        {
            "id": "https://queek.cn/2025/02/17/xlsx%E4%BF%AE%E6%94%B9%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6/",
            "url": "https://queek.cn/2025/02/17/xlsx%E4%BF%AE%E6%94%B9%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6/",
            "title": "xlsx修改加密文件",
            "date_published": "2025-02-17T11:04:45.000Z",
            "content_html": "<h3 id=\"xlsx解密修改文件内容并重新加密下载\"><a href=\"#xlsx解密修改文件内容并重新加密下载\" class=\"headerlink\" title=\"xlsx解密修改文件内容并重新加密下载\"></a>xlsx解密修改文件内容并重新加密下载</h3><figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> &#123;</span><br><span class=\"line\">    <span class=\"title class_\">ZipReader</span>,</span><br><span class=\"line\">    <span class=\"title class_\">BlobReader</span>,</span><br><span class=\"line\">    <span class=\"title class_\">TextWriter</span>,</span><br><span class=\"line\">    <span class=\"title class_\">ZipWriter</span>,</span><br><span class=\"line\">    <span class=\"title class_\">BlobWriter</span></span><br><span class=\"line\">&#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;@zip.js/zip.js&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"variable constant_\">XLSX</span> <span class=\"keyword\">from</span> <span class=\"string\">&#x27;xlsx&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">KeepZero</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> getKeepZeroXlsx = <span class=\"function\">(<span class=\"params\">blob, password, path</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">extractAndDecryptXlsx</span>(blob, password, path).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">zipContent</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (zipContent) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;解密成功，文件已经处理&#x27;</span>, zipContent);</span><br><span class=\"line\">                <span class=\"keyword\">const</span> xlsxBlob = <span class=\"variable language_\">this</span>.<span class=\"title function_\">convertToXLSX</span>(zipContent);</span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;xlsxBlob&#x27;</span>, xlsxBlob);</span><br><span class=\"line\">                <span class=\"comment\">// this.readAndPrintXLSX(xlsxBlob);</span></span><br><span class=\"line\">                <span class=\"keyword\">const</span> nowBolb = <span class=\"variable language_\">this</span>.<span class=\"title function_\">encryptAndDownload</span>(xlsxBlob, password, path);</span><br><span class=\"line\">                <span class=\"comment\">// console.log(&#x27;nowBolb&#x27;, nowBolb);</span></span><br><span class=\"line\">                <span class=\"comment\">// 你可以在这里进一步操作解压后的文件内容</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 解压 ZIP，提取并解密 .xlsx 文件</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> extractAndDecryptXlsx = <span class=\"title function_\">async</span> (blob, password, path) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 创建 ZipReader 实例，提供密码</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> reader = <span class=\"keyword\">new</span> <span class=\"title class_\">ZipReader</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">BlobReader</span>(blob), &#123; password &#125;);</span><br><span class=\"line\">            <span class=\"comment\">// 获取文件条目</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> entries = <span class=\"keyword\">await</span> reader.<span class=\"title function_\">getEntries</span>();</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">if</span> (entries.<span class=\"property\">length</span> === <span class=\"number\">1</span> &amp;&amp; !entries[<span class=\"number\">0</span>].<span class=\"property\">directory</span>) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 读取文件内容为文本</span></span><br><span class=\"line\">                <span class=\"keyword\">const</span> content = <span class=\"keyword\">await</span> entries[<span class=\"number\">0</span>].<span class=\"property\">getData</span>?.(<span class=\"keyword\">new</span> <span class=\"title class_\">TextWriter</span>());</span><br><span class=\"line\">                <span class=\"comment\">// 关闭读取器</span></span><br><span class=\"line\">                <span class=\"keyword\">await</span> reader.<span class=\"title function_\">close</span>();</span><br><span class=\"line\">                <span class=\"keyword\">return</span> &#123; <span class=\"attr\">filename</span>: path, content &#125;; <span class=\"comment\">// 返回文件名和内容</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">error</span>(<span class=\"string\">&#x27;ZIP 文件包含多个文件或没有文件&#x27;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (err) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">error</span>(<span class=\"string\">&#x27;解密失败:&#x27;</span>, err);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> convertToXLSX = <span class=\"function\">(<span class=\"params\">fileContent</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;XLSX?.utils&#x27;</span>, <span class=\"variable constant_\">XLSX</span>.<span class=\"property\">utils</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 创建一个新的工作簿</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> workbook = <span class=\"variable constant_\">XLSX</span>.<span class=\"property\">utils</span>.<span class=\"title function_\">book_new</span>();</span><br><span class=\"line\">        <span class=\"comment\">// 假设内容是 CSV 格式，按逗号分隔每行</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> csvData = fileContent.<span class=\"property\">content</span>.<span class=\"title function_\">split</span>(<span class=\"string\">&#x27;\\n&#x27;</span>).<span class=\"title function_\">map</span>(<span class=\"function\"><span class=\"params\">line</span> =&gt;</span> line.<span class=\"title function_\">split</span>(<span class=\"string\">&#x27;,&#x27;</span>));</span><br><span class=\"line\">        <span class=\"comment\">// 创建一个工作表</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> worksheet = <span class=\"variable constant_\">XLSX</span>.<span class=\"property\">utils</span>.<span class=\"title function_\">aoa_to_sheet</span>(csvData);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 遍历工作表数据，强制将某些列作为文本处理以保留前导零</span></span><br><span class=\"line\">        <span class=\"title class_\">Object</span>.<span class=\"title function_\">keys</span>(worksheet).<span class=\"title function_\">forEach</span>(<span class=\"function\"><span class=\"params\">cellAddress</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> cell = worksheet[cellAddress];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cell &amp;&amp; <span class=\"keyword\">typeof</span> cell.<span class=\"property\">v</span> === <span class=\"string\">&#x27;string&#x27;</span> &amp;&amp; <span class=\"regexp\">/^[0-9]+$/</span>.<span class=\"title function_\">test</span>(cell.<span class=\"property\">v</span>)) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 如果单元格的值是纯数字字符串，则设置为文本格式</span></span><br><span class=\"line\">                cell.<span class=\"property\">z</span> = <span class=\"string\">&#x27;@&#x27;</span>; <span class=\"comment\">// 设置单元格为文本格式</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 将工作表添加到工作簿</span></span><br><span class=\"line\">        <span class=\"variable constant_\">XLSX</span>?.<span class=\"property\">utils</span>?.<span class=\"title function_\">book_append_sheet</span>(workbook, worksheet, <span class=\"string\">&#x27;Sheet1&#x27;</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 导出为 XLSX 文件</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> xlsxArray = <span class=\"variable constant_\">XLSX</span>?.<span class=\"property\">write</span>?.(workbook, &#123; <span class=\"attr\">bookType</span>: <span class=\"string\">&#x27;xlsx&#x27;</span>, <span class=\"attr\">type</span>: <span class=\"string\">&#x27;array&#x27;</span> &#125;);</span><br><span class=\"line\">        <span class=\"comment\">// 使用 Blob 构造函数将数组转换为 Blob</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> xlsxBlob = <span class=\"keyword\">new</span> <span class=\"title class_\">Blob</span>([xlsxArray], &#123; <span class=\"attr\">type</span>: <span class=\"string\">&#x27;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#x27;</span> &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> xlsxBlob; <span class=\"comment\">// 返回生成的 Blob 对象</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 读取生成的 XLSX 文件并打印内容</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> readAndPrintXLSX = <span class=\"function\">(<span class=\"params\">xlsxBlob</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建 FileReader 实例读取 Blob</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> reader = <span class=\"keyword\">new</span> <span class=\"title class_\">FileReader</span>();</span><br><span class=\"line\">        reader.<span class=\"property\">onload</span> = <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> data = <span class=\"keyword\">new</span> <span class=\"title class_\">Uint8Array</span>(e.<span class=\"property\">target</span>.<span class=\"property\">result</span>);</span><br><span class=\"line\">            <span class=\"keyword\">const</span> workbook = <span class=\"variable constant_\">XLSX</span>.<span class=\"title function_\">read</span>(data, &#123; <span class=\"attr\">type</span>: <span class=\"string\">&#x27;array&#x27;</span> &#125;);</span><br><span class=\"line\">            <span class=\"comment\">// 获取第一个工作表</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> firstSheetName = workbook.<span class=\"property\">SheetNames</span>[<span class=\"number\">0</span>];</span><br><span class=\"line\">            <span class=\"keyword\">const</span> worksheet = workbook.<span class=\"property\">Sheets</span>[firstSheetName];</span><br><span class=\"line\">            <span class=\"comment\">// 将工作表内容转换为 JSON 格式</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> sheetData = <span class=\"variable constant_\">XLSX</span>.<span class=\"property\">utils</span>.<span class=\"title function_\">sheet_to_json</span>(worksheet, &#123; <span class=\"attr\">header</span>: <span class=\"number\">1</span> &#125;);</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;打印 XLSX 内容:&#x27;</span>, sheetData); <span class=\"comment\">// 打印内容</span></span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        reader.<span class=\"title function_\">readAsArrayBuffer</span>(xlsxBlob);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 使用 @zip.js/zip.js 加密生成的 XLSX 文件并下载</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> encryptAndDownload = <span class=\"title function_\">async</span> (xlsxBlob, password, path) =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 创建 ZipWriter 实例</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> zipWriter = <span class=\"keyword\">new</span> <span class=\"title class_\">ZipWriter</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">BlobWriter</span>(<span class=\"string\">&#x27;application/zip&#x27;</span>), &#123; password &#125;);</span><br><span class=\"line\">            <span class=\"comment\">// 将 XLSX 文件添加到 ZIP 包中</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> zipWriter.<span class=\"title function_\">add</span>(<span class=\"string\">`<span class=\"subst\">$&#123;path&#125;</span>.xlsx`</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">BlobReader</span>(xlsxBlob));</span><br><span class=\"line\">            <span class=\"comment\">// 关闭并获取加密后的 ZIP Blob</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> encryptedZipBlob = <span class=\"keyword\">await</span> zipWriter.<span class=\"title function_\">close</span>();</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">// 创建下载链接</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> url = <span class=\"variable constant_\">URL</span>.<span class=\"title function_\">createObjectURL</span>(encryptedZipBlob);</span><br><span class=\"line\">            <span class=\"keyword\">const</span> a = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">&#x27;a&#x27;</span>);</span><br><span class=\"line\">            a.<span class=\"property\">href</span> = url;</span><br><span class=\"line\">            a.<span class=\"property\">download</span> = <span class=\"string\">`<span class=\"subst\">$&#123;path || <span class=\"string\">&#x27;&#x27;</span>&#125;</span>.zip`</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">document</span>.<span class=\"property\">body</span>.<span class=\"title function_\">appendChild</span>(a);</span><br><span class=\"line\">            a.<span class=\"title function_\">click</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">document</span>.<span class=\"property\">body</span>.<span class=\"title function_\">removeChild</span>(a);</span><br><span class=\"line\">            <span class=\"variable constant_\">URL</span>.<span class=\"title function_\">revokeObjectURL</span>(url); <span class=\"comment\">// 释放 URL</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (err) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">error</span>(<span class=\"string\">&#x27;加密失败:&#x27;</span>, err);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 实例化类并调用方法</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> keepZero = <span class=\"keyword\">new</span> <span class=\"title class_\">KeepZero</span>();</span><br><span class=\"line\"><span class=\"keyword\">const</span> name = action.<span class=\"property\">payload</span>.<span class=\"property\">excelName</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> realName = name.<span class=\"title function_\">slice</span>(-<span class=\"number\">4</span>) === <span class=\"string\">&#x27;.zip&#x27;</span> ? name.<span class=\"title function_\">substring</span>(<span class=\"number\">0</span>, name.<span class=\"property\">length</span> - <span class=\"number\">4</span>) : name;</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;realName&#x27;</span>, realName);</span><br><span class=\"line\">keepZero.<span class=\"title function_\">getKeepZeroXlsx</span>(res.<span class=\"property\">data</span>, <span class=\"string\">&#x27;123455&#x27;</span>, realName);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n",
            "tags": [
                "xlsx"
            ]
        }
    ]
}